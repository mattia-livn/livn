<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Livn - Calcolo IMU 2025</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            margin-bottom: 30px;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
            gap: 20px;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            border-radius: 50px;
            border: 2px solid #e0e0e0;
            color: #999;
            font-weight: 500;
            transition: all 0.3s;
        }

        .step.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .step.completed {
            border-color: #4CAF50;
            background: #4CAF50;
            color: white;
        }

        .step-number {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: currentColor;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .step.active .step-number,
        .step.completed .step-number {
            background: rgba(255,255,255,0.3);
        }

        /* Upload Area */
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #5a6fd8;
            background: #f0f2ff;
        }

        .upload-area.dragover {
            border-color: #4CAF50;
            background: #f0fff0;
        }

        .upload-icon {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.3rem;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: #999;
            font-size: 1rem;
        }

        /* File List */
        .file-list {
            margin-top: 30px;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .file-icon {
            font-size: 1.5rem;
            color: #667eea;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: #333;
        }

        .file-size {
            color: #999;
            font-size: 0.9rem;
        }

        .file-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .file-status.uploaded {
            background: #e8f5e8;
            color: #4CAF50;
        }

        .file-status.analyzing {
            background: #fff3cd;
            color: #856404;
        }

        .file-status.completed {
            background: #e8f5e8;
            color: #4CAF50;
        }

        .file-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        /* Buttons */
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e0e0e0;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .hidden {
            display: none;
        }

        /* Progress */
        .progress-container {
            margin-top: 30px;
        }

        .progress-item {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .data-table tr:hover {
            background: #f8f9ff;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-icon {
            font-size: 1.8rem;
        }

        /* Questions */
        .question-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .question-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.4rem;
        }

        .question-description {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .question-options {
            margin-bottom: 25px;
        }

        .option-label {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option-label:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .option-label input[type="radio"],
        .option-label input[type="checkbox"] {
            margin: 0;
        }

        .option-text {
            flex: 1;
            font-weight: 500;
        }

        /* Object Questions */
        .question-fields {
            margin-bottom: 25px;
        }

        .field-group {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f8f9fa;
        }

        .field-label {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .field-options {
            margin-left: 10px;
        }

        .field-options .option-label {
            background: white;
            margin-bottom: 8px;
            padding: 12px;
        }

        .field-options .option-label:hover {
            border-color: #667eea;
            background: #f0f2ff;
        }

        /* Calculation Results */
        .calculation-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
        }

        .calculation-summary h3 {
            font-size: 2rem;
            margin-bottom: 20px;
        }

        .payment-schedule {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
        }

        .payment-item {
            background: rgba(255,255,255,0.2);
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
        }

        .payment-date {
            display: block;
            font-size: 0.9rem;
            margin-top: 5px;
            opacity: 0.9;
        }

        .calculation-details {
            margin-bottom: 30px;
        }

        .calculation-details h4 {
            margin-bottom: 20px;
            color: #333;
        }

        .calculation-notes {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #28a745;
        }

        .calculation-notes h4 {
            color: #28a745;
            margin-bottom: 15px;
        }

        .calculation-notes ul {
            list-style: none;
            padding: 0;
        }

        .calculation-notes li {
            padding: 5px 0;
            color: #495057;
        }

        /* Report */
        .report-summary {
            background: #f8f9ff;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border-left: 5px solid #667eea;
        }

        .report-section {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .report-section h4 {
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .total-amount {
            font-size: 1.3rem;
            color: #28a745;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .schedule p {
            margin: 8px 0;
            color: #666;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .step-indicator {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .step {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            
            .card {
                padding: 20px;
            }

            .payment-schedule {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üè† Livn</h1>
            <p>Calcolo IMU 2025 - Semplice, veloce, preciso</p>
        </div>

        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step active" id="step-1">
                <div class="step-number">1</div>
                <span>Upload File</span>
            </div>
            <div class="step" id="step-2">
                <div class="step-number">2</div>
                <span>Analisi</span>
            </div>
            <div class="step" id="step-3">
                <div class="step-number">3</div>
                <span>Dati</span>
            </div>
            <div class="step" id="step-4">
                <div class="step-number">4</div>
                <span>Domande</span>
            </div>
            <div class="step" id="step-5">
                <div class="step-number">5</div>
                <span>Calcolo</span>
            </div>
            <div class="step" id="step-6">
                <div class="step-number">6</div>
                <span>Report</span>
            </div>
        </div>

        <!-- Step 1: Upload -->
        <div class="card" id="upload-section">
            <h2 class="section-title">
                <span class="section-icon">üìÅ</span>
                Carica le tue visure catastali
            </h2>
            
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">üìÑ</div>
                <div class="upload-text">Trascina qui i tuoi file</div>
                <div class="upload-subtext">oppure clicca per selezionare (PDF, TXT, CSV)</div>
                <input type="file" id="file-input" multiple accept=".pdf,.txt,.csv" style="display: none;">
            </div>

            <div class="file-list" id="file-list"></div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" id="analyze-btn" disabled>
                    üîç Analizza File
                </button>
            </div>
        </div>

        <!-- Step 2: Analysis Progress -->
        <div class="card hidden" id="analysis-section">
            <h2 class="section-title">
                <span class="section-icon">‚öôÔ∏è</span>
                Analisi in corso...
            </h2>
            <div class="progress-container" id="progress-container"></div>
        </div>

        <!-- Step 3: Data Tables -->
        <div class="card hidden" id="data-section">
            <h2 class="section-title">
                <span class="section-icon">üìä</span>
                Dati estratti dalle visure
            </h2>
            
            <!-- Fabbricati Table -->
            <div id="fabbricati-section"></div>
            
            <!-- Terreni Table -->
            <div id="terreni-section"></div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" id="continue-btn">
                    ‚û°Ô∏è Continua con le domande
                </button>
            </div>
        </div>

        <!-- Step 4: Questions -->
        <div class="card hidden" id="questions-section">
            <h2 class="section-title">
                <span class="section-icon">‚ùì</span>
                Informazioni aggiuntive
            </h2>
            <div id="questions-container"></div>
        </div>

        <!-- Step 5: Calculation -->
        <div class="card hidden" id="calculation-section">
            <h2 class="section-title">
                <span class="section-icon">üßÆ</span>
                Calcolo IMU 2025
            </h2>
            <div id="calculation-results"></div>
        </div>

        <!-- Step 6: Report -->
        <div class="card hidden" id="report-section">
            <h2 class="section-title">
                <span class="section-icon">üìë</span>
                Report finale
            </h2>
            <div id="report-content"></div>
        </div>
    </div>

    <script>
        // Global state
        let currentStep = 1;
        let uploadedFiles = [];
        let extractedData = null;
        let userAnswers = {};

        // DOM Elements
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const fileList = document.getElementById('file-list');
        const analyzeBtn = document.getElementById('analyze-btn');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupUploadArea();
            setupEventListeners();
        });

        function setupUploadArea() {
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            fileInput.addEventListener('change', handleFileSelect);
        }

        function setupEventListeners() {
            analyzeBtn.addEventListener('click', startAnalysis);
            document.getElementById('continue-btn')?.addEventListener('click', () => startQuestions());
        }

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            addFiles(files);
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            addFiles(files);
        }

        function addFiles(files) {
            files.forEach(file => {
                if (!uploadedFiles.find(f => f.name === file.name)) {
                    const fileInfo = {
                        file: file,
                        name: file.name,
                        size: formatFileSize(file.size),
                        status: 'uploaded',
                        id: Date.now() + Math.random()
                    };
                    uploadedFiles.push(fileInfo);
                    renderFileItem(fileInfo);
                }
            });
            
            analyzeBtn.disabled = uploadedFiles.length === 0;
        }

        function renderFileItem(fileInfo) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <div class="file-icon">üìÑ</div>
                <div class="file-info">
                    <div class="file-name">${fileInfo.name}</div>
                    <div class="file-size">${fileInfo.size}</div>
                </div>
                <div class="file-status ${fileInfo.status}">${getStatusText(fileInfo.status)}</div>
            `;
            fileList.appendChild(fileItem);
        }

        function getStatusText(status) {
            const statusMap = {
                'uploaded': 'Caricato',
                'analyzing': 'Analisi...',
                'completed': 'Completato',
                'error': 'Errore'
            };
            return statusMap[status] || status;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function startAnalysis() {
            goToStep(2);
            
            // Prepare form data
            const formData = new FormData();
            uploadedFiles.forEach(fileInfo => {
                formData.append('files', fileInfo.file);
            });

            // Show loading
            const progressContainer = document.getElementById('progress-container');
            progressContainer.innerHTML = '<div class="progress-item">üîç Analisi in corso...</div>';

            try {
                console.log('üì° Inizio analisi con polling...');
                
                // Step 1: Avvia analisi
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (!result.success) {
                    console.error('‚ùå Errore API analyze:', result.error);
                    showError(`Errore durante l'analisi: ${result.error || 'Errore sconosciuto'}`);
                    return;
                }

                console.log('‚úÖ Analisi avviata, sessionId:', result.sessionId);
                const sessionId = result.sessionId;

                // Step 2: Polling del progresso
                const pollProgress = async () => {
                    try {
                        const progressResponse = await fetch(`/api/progress/${sessionId}`);
                        const progressResult = await progressResponse.json();
                        
                        if (!progressResult.success) {
                            throw new Error(progressResult.error || 'Errore polling');
                        }

                        // Aggiorna UI con progresso
                        progressContainer.innerHTML = progressResult.progress
                            .map(p => `<div class="progress-item">${p.message}</div>`)
                            .join('');

                        console.log('üìä Status:', progressResult.status);

                        if (progressResult.status === 'completed') {
                            // Analisi completata con successo
                            console.log('‚úÖ Analisi completata!');
                            
                            if (progressResult.data) {
                                extractedData = progressResult.data;
                                extractedData.sessionId = sessionId; // Aggiungi sessionId
                                
                                console.log('üì¶ Dati estratti:', extractedData);
                                renderDataTables();
                                goToStep(3);
                            } else {
                                throw new Error('Dati estratti non disponibili');
                            }
                            
                        } else if (progressResult.status === 'error') {
                            // Errore durante analisi
                            const lastMessage = progressResult.progress[progressResult.progress.length - 1]?.message || 'Errore sconosciuto';
                            throw new Error(lastMessage);
                            
                        } else {
                            // Ancora in corso, continua polling
                            setTimeout(pollProgress, 2000);
                        }

                    } catch (error) {
                        console.error('‚ùå Errore polling:', error);
                        showError(`Errore durante l'analisi: ${error.message}`);
                    }
                };

                // Avvia polling
                setTimeout(pollProgress, 1000);

            } catch (error) {
                console.error('‚ùå Errore startAnalysis:', error);
                showError(`Errore durante l'analisi: ${error.message}`);
            }
        }

        function renderDataTables() {
            // Controllo di sicurezza per extractedData
            if (!extractedData) {
                console.error('‚ùå extractedData √® null o undefined');
                return;
            }
            
            const dataSection = document.getElementById('data-section');
            
            // Assicurati che gli array esistano
            if (!extractedData.fabbricati) extractedData.fabbricati = [];
            if (!extractedData.terreni) extractedData.terreni = [];
            
            if (extractedData.fabbricati && extractedData.fabbricati.length > 0) {
                renderFabbricatiTable();
            } else {
                // Mostra messaggio se non ci sono fabbricati
                const section = document.getElementById('fabbricati-section');
                section.innerHTML = '<div class="progress-item">üìã Nessun fabbricato trovato</div>';
            }
            
            if (extractedData.terreni && extractedData.terreni.length > 0) {
                renderTerreniTable();
            } else {
                // Mostra messaggio se non ci sono terreni  
                const section = document.getElementById('terreni-section');
                if (!section.innerHTML.includes('Nessun terreno')) {
                    section.innerHTML += '<div class="progress-item">üåæ Nessun terreno trovato</div>';
                }
            }
        }

        function renderFabbricatiTable() {
            // Raggruppa fabbricati per comune
            const fabbricatiPerComune = {};
            extractedData.fabbricati.forEach(fab => {
                const chiaveComune = `${fab.comune} (${fab.provincia})`;
                if (!fabbricatiPerComune[chiaveComune]) {
                    fabbricatiPerComune[chiaveComune] = [];
                }
                fabbricatiPerComune[chiaveComune].push(fab);
            });

            const section = document.getElementById('fabbricati-section');
            let html = `<h3 class="section-title">üè† Fabbricati (${extractedData.fabbricati.length})</h3>`;
            
            // Crea una tabella per ogni comune
            Object.entries(fabbricatiPerComune).forEach(([comune, fabbricati]) => {
                html += `
                    <h4 style="margin-top: 30px; margin-bottom: 15px; color: #667eea;">üìç ${comune} (${fabbricati.length} immobili)</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Foglio</th>
                                <th>Particella</th>
                                <th>Subalterno</th>
                                <th>Categoria</th>
                                <th>Classe</th>
                                <th>Rendita</th>
                                <th>Ubicazione</th>
                                <th>Titolarit√†</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${fabbricati.map(fab => `
                                <tr>
                                    <td>${fab.foglio}</td>
                                    <td>${fab.particella}</td>
                                    <td>${fab.subalterno || '-'}</td>
                                    <td>${fab.categoria}</td>
                                    <td>${fab.classe}</td>
                                    <td>‚Ç¨${fab.rendita.toFixed(2)}</td>
                                    <td>${fab.ubicazione || '-'}</td>
                                    <td>${fab.proprietario?.titolarita || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            });
            
            section.innerHTML = html;
        }

        function renderTerreniTable() {
            if (!extractedData.terreni || extractedData.terreni.length === 0) return;
            
            // Raggruppa terreni per comune
            const terreniPerComune = {};
            extractedData.terreni.forEach(ter => {
                const chiaveComune = `${ter.comune} (${ter.provincia})`;
                if (!terreniPerComune[chiaveComune]) {
                    terreniPerComune[chiaveComune] = [];
                }
                terreniPerComune[chiaveComune].push(ter);
            });

            const section = document.getElementById('terreni-section');
            let html = `<h3 class="section-title">üå± Terreni (${extractedData.terreni.length})</h3>`;
            
            // Crea una tabella per ogni comune
            Object.entries(terreniPerComune).forEach(([comune, terreni]) => {
                html += `
                    <h4 style="margin-top: 30px; margin-bottom: 15px; color: #667eea;">üìç ${comune} (${terreni.length} terreni)</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Foglio</th>
                                <th>Particella</th>
                                <th>Qualit√†</th>
                                <th>Classe</th>
                                <th>Superficie</th>
                                <th>RD</th>
                                <th>RA</th>
                                <th>Ubicazione</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${terreni.map(ter => `
                                <tr>
                                    <td>${ter.foglio}</td>
                                    <td>${ter.particella}</td>
                                    <td>${ter.qualita}</td>
                                    <td>${ter.classe}</td>
                                    <td>${ter.superficie} mq</td>
                                    <td>‚Ç¨${ter.redditoDominicale.toFixed(2)}</td>
                                    <td>‚Ç¨${ter.redditoAgrario.toFixed(2)}</td>
                                    <td>${ter.ubicazione || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            });
            
            section.innerHTML = html;
        }

        function goToStep(stepNumber) {
            // Update step indicator
            for (let i = 1; i <= 6; i++) {
                const step = document.getElementById(`step-${i}`);
                step.classList.remove('active', 'completed');
                
                if (i < stepNumber) {
                    step.classList.add('completed');
                } else if (i === stepNumber) {
                    step.classList.add('active');
                }
            }

            // Hide all sections
            document.querySelectorAll('.card').forEach(card => {
                card.classList.add('hidden');
            });

            // Show current section
            const sections = {
                1: 'upload-section',
                2: 'analysis-section', 
                3: 'data-section',
                4: 'questions-section',
                5: 'calculation-section',
                6: 'report-section'
            };

            const currentSection = document.getElementById(sections[stepNumber]);
            if (currentSection) {
                currentSection.classList.remove('hidden');
            }

            currentStep = stepNumber;
        }

        async function startQuestions() {
            goToStep(4);
            await loadNextQuestion();
        }

        async function loadNextQuestion() {
            try {
                // Controllo di sicurezza per sessionId
                if (!extractedData || !extractedData.sessionId) {
                    console.error('‚ùå SessionId mancante');
                    showError('Errore: SessionId mancante. Riprova l\'analisi.');
                    goToStep(1);
                    return;
                }
                
                // Il server attuale gestisce le domande con POST
                const response = await fetch(`/api/questions/${extractedData.sessionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ answers: userAnswers })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.questions && result.questions.length > 0) {
                        // Mostra la prima domanda disponibile
                        renderQuestion(result.questions[0]);
                    } else if (result.isComplete) {
                        // Nessuna domanda rimanente, vai al calcolo
                        startCalculation();
                    } else {
                        showError('Nessuna domanda disponibile');
                    }
                } else {
                    showError(`Errore nel caricamento domande: ${result.error}`);
                }
            } catch (error) {
                console.error('‚ùå Errore loadNextQuestion:', error);
                showError('Errore di connessione');
            }
        }

        function renderQuestion(question) {
            const container = document.getElementById('questions-container');
            
            let questionHTML = `
                <div class="question-card">
                    <h3>${question.title}</h3>
                    <p class="question-description">${question.description}</p>
            `;

            if (question.type === 'select') {
                questionHTML += `
                    <div class="question-options">
                        ${question.options.map(option => `
                            <label class="option-label">
                                <input type="radio" name="${question.id}" value="${option.value}">
                                <span class="option-text">${option.label}</span>
                            </label>
                        `).join('')}
                    </div>
                `;
            } else if (question.type === 'multiselect') {
                questionHTML += `
                    <div class="question-options">
                        ${question.options.map(option => `
                            <label class="option-label">
                                <input type="checkbox" name="${question.id}" value="${option.value}">
                                <span class="option-text">${option.label}</span>
                            </label>
                        `).join('')}
                    </div>
                `;
            } else if (question.type === 'object') {
                // Gestione domande di tipo object (pertinenze e condizioni immobili)
                questionHTML += `<div class="question-fields">`;
                
                question.fields.forEach(field => {
                    questionHTML += `
                        <div class="field-group">
                            <h4 class="field-label">${field.label}</h4>
                    `;
                    
                    if (field.type === 'select') {
                        questionHTML += `
                            <div class="field-options">
                                ${field.options.map(option => `
                                    <label class="option-label">
                                        <input type="radio" name="${field.id}" value="${option.value}">
                                        <span class="option-text">${option.label}</span>
                                    </label>
                                `).join('')}
                            </div>
                        `;
                    } else if (field.type === 'multiselect') {
                        questionHTML += `
                            <div class="field-options">
                                ${field.options.map(option => `
                                    <label class="option-label">
                                        <input type="checkbox" name="${field.id}" value="${option.value}">
                                        <span class="option-text">${option.label}</span>
                                    </label>
                                `).join('')}
                            </div>
                        `;
                    }
                    
                    questionHTML += `</div>`; // Chiude field-group
                });
                
                questionHTML += `</div>`; // Chiude question-fields
            }

            questionHTML += `
                    <div class="question-actions">
                        <button class="btn btn-primary" onclick="submitAnswer('${question.id}', '${question.type}', ${question.required})">
                            ‚û°Ô∏è Continua
                        </button>
                    </div>
                </div>
            `;

            container.innerHTML = questionHTML;
            
            // NUOVA LOGICA: Gestione esclusivit√† abitazione principale
            if (question.type === 'object') {
                setupAbitazionePrincipaleExclusivity();
            }
        }

        function setupAbitazionePrincipaleExclusivity() {
            // Trova tutti i radio button "abitazione_principale"
            const abitazionePrincipaleRadios = document.querySelectorAll('input[type="radio"][value="abitazione_principale"]');
            
            if (abitazionePrincipaleRadios.length > 1) {
                console.log('üè† Configurazione esclusivit√† abitazione principale per', abitazionePrincipaleRadios.length, 'immobili');
                
                // Aggiungi listener a ciascun radio button "abitazione_principale"
                abitazionePrincipaleRadios.forEach(radio => {
                    radio.addEventListener('change', handleAbitazionePrincipaleChange);
                });
                
                // NUOVA LOGICA: Aggiungi listener anche agli altri radio button dello stesso gruppo
                // per rilevare quando l'utente cambia da abitazione_principale ad altro
                abitazionePrincipaleRadios.forEach(radio => {
                    const fieldGroup = radio.closest('.field-group');
                    const allRadiosInGroup = fieldGroup.querySelectorAll('input[type="radio"]');
                    
                    allRadiosInGroup.forEach(groupRadio => {
                        if (groupRadio.value !== 'abitazione_principale') {
                            groupRadio.addEventListener('change', handleOtherOptionChange);
                        }
                    });
                });
                
                // Controlla stato iniziale
                updateAbitazionePrincipaleState();
            }
        }

        function handleAbitazionePrincipaleChange(event) {
            console.log('üè† Abitazione principale selezionata:', event.target.name);
            updateAbitazionePrincipaleState();
        }

        function handleOtherOptionChange(event) {
            // Quando l'utente seleziona un'altra opzione (non abitazione_principale)
            // ricontrolla lo stato per riabilitare eventualmente altri immobili
            console.log('üè† Opzione cambiata da abitazione principale:', event.target.name, '=', event.target.value);
            updateAbitazionePrincipaleState();
        }

        function updateAbitazionePrincipaleState() {
            const abitazionePrincipaleRadios = document.querySelectorAll('input[type="radio"][value="abitazione_principale"]');
            const selectedRadio = document.querySelector('input[type="radio"][value="abitazione_principale"]:checked');
            
            abitazionePrincipaleRadios.forEach(radio => {
                const parentLabel = radio.closest('label');
                const fieldGroup = radio.closest('.field-group');
                
                if (selectedRadio && selectedRadio !== radio) {
                    // Disabilita altri radio "abitazione_principale"
                    radio.disabled = true;
                    parentLabel.classList.add('disabled');
                    parentLabel.style.opacity = '0.5';
                    parentLabel.style.pointerEvents = 'none';
                    
                    // Aggiungi indicazione visiva
                    if (!parentLabel.querySelector('.disabled-indicator')) {
                        const indicator = document.createElement('span');
                        indicator.className = 'disabled-indicator';
                        indicator.innerHTML = ' (gi√† selezionata altrove)';
                        indicator.style.color = '#666';
                        indicator.style.fontSize = '0.9em';
                        indicator.style.fontStyle = 'italic';
                        parentLabel.appendChild(indicator);
                    }
                } else {
                    // Riabilita se nessuno √® selezionato o se √® quello selezionato
                    radio.disabled = false;
                    parentLabel.classList.remove('disabled');
                    parentLabel.style.opacity = '';
                    parentLabel.style.pointerEvents = '';
                    
                    // Rimuovi indicazione visiva
                    const indicator = parentLabel.querySelector('.disabled-indicator');
                    if (indicator) {
                        indicator.remove();
                    }
                }
            });
        }

        async function submitAnswer(questionId, questionType, required) {
            let answer;
            
            if (questionType === 'select') {
                const selected = document.querySelector(`input[name="${questionId}"]:checked`);
                if (required && !selected) {
                    alert('Seleziona una risposta');
                    return;
                }
                answer = selected?.value;
            } else if (questionType === 'multiselect') {
                const selected = document.querySelectorAll(`input[name="${questionId}"]:checked`);
                answer = Array.from(selected).map(input => input.value);
            } else if (questionType === 'object') {
                // Gestione domande di tipo object
                answer = {};
                
                // Trova tutti i campi della domanda
                const fieldGroups = document.querySelectorAll('.field-group');
                
                fieldGroups.forEach(fieldGroup => {
                    // Trova il nome del campo dal primo input del gruppo
                    const firstInput = fieldGroup.querySelector('input');
                    if (firstInput) {
                        const fieldName = firstInput.name;
                        
                        // Controlla se √® select o multiselect
                        const radioInputs = fieldGroup.querySelectorAll('input[type="radio"]');
                        const checkboxInputs = fieldGroup.querySelectorAll('input[type="checkbox"]');
                        
                        if (radioInputs.length > 0) {
                            // Campo select (radio)
                            const selectedRadio = fieldGroup.querySelector('input[type="radio"]:checked');
                            if (selectedRadio) {
                                answer[fieldName] = selectedRadio.value;
                            }
                        } else if (checkboxInputs.length > 0) {
                            // Campo multiselect (checkbox)
                            const selectedCheckboxes = fieldGroup.querySelectorAll('input[type="checkbox"]:checked');
                            answer[fieldName] = Array.from(selectedCheckboxes).map(input => input.value);
                        }
                    }
                });
                
                console.log('üíæ Risposta object raccolta:', answer);
            }

            // Controllo di sicurezza per sessionId
            if (!extractedData || !extractedData.sessionId) {
                console.error('‚ùå SessionId mancante in submitAnswer');
                showError('Errore: SessionId mancante. Riprova l\'analisi.');
                goToStep(1);
                return;
            }

            // Aggiorna le risposte locali
            userAnswers[questionId] = answer;
            console.log('üíæ Risposta aggiunta:', questionId, '=', answer);
            console.log('üíæ Risposte utente aggiornate:', userAnswers);

            // Ricarica la prossima domanda
            await loadNextQuestion();
        }

        async function startCalculation() {
            goToStep(5);
            
            // Controllo di sicurezza per sessionId
            if (!extractedData || !extractedData.sessionId) {
                console.error('‚ùå SessionId mancante in startCalculation');
                showError('Errore: SessionId mancante. Riprova l\'analisi.');
                goToStep(1);
                return;
            }
            
            try {
                const response = await fetch(`/api/calculate/${extractedData.sessionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();
                
                if (result.success) {
                    renderCalculationResults(result.calculation);
                    setTimeout(() => {
                        showReportButton();
                    }, 2000);
                } else {
                    showError('Errore nel calcolo IMU');
                }
            } catch (error) {
                console.error('‚ùå Errore startCalculation:', error);
                showError('Errore di connessione durante il calcolo');
            }
        }

        function renderCalculationResults(calculation) {
            const container = document.getElementById('calculation-results');
            
            container.innerHTML = `
                <div class="calculation-summary">
                    <h3>üí∞ Totale IMU 2025: ‚Ç¨${calculation.totalIMU.toFixed(2)}</h3>
                    <div class="payment-schedule">
                        <div class="payment-item">
                            <strong>Acconto:</strong> ‚Ç¨${calculation.acconto.toFixed(2)} 
                            <span class="payment-date">(entro il 16/06/2025)</span>
                        </div>
                        <div class="payment-item">
                            <strong>Saldo:</strong> ‚Ç¨${calculation.saldo.toFixed(2)} 
                            <span class="payment-date">(entro il 16/12/2025)</span>
                        </div>
                    </div>
                </div>

                <div class="calculation-details">
                    <h4>üìä Dettaglio per immobile:</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Immobile</th>
                                <th>Tipo</th>
                                <th>Base Imponibile</th>
                                <th>Aliquota</th>
                                <th>Detrazione</th>
                                <th>IMU</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${calculation.details.map(detail => `
                                <tr>
                                    <td>${detail.immobile}</td>
                                    <td>${detail.tipo}</td>
                                    <td>‚Ç¨${detail.baseImponibile.toFixed(2)}</td>
                                    <td>${detail.aliquota}%</td>
                                    <td>‚Ç¨${detail.detrazione.toFixed(2)}</td>
                                    <td><strong>‚Ç¨${detail.importo.toFixed(2)}</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>

                <div class="calculation-notes">
                    <h4>üìã Normativa applicata:</h4>
                    <ul>
                        ${calculation.normativa.map(nota => `<li>${nota}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        function showReportButton() {
            const container = document.getElementById('calculation-results');
            container.innerHTML += `
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="generateReport()">
                        üìë Genera Report
                    </button>
                </div>
            `;
        }

        async function generateReport() {
            goToStep(6);
            
            // Controllo di sicurezza per sessionId
            if (!extractedData || !extractedData.sessionId) {
                console.error('‚ùå SessionId mancante in generateReport');
                showError('Errore: SessionId mancante. Riprova l\'analisi.');
                goToStep(1);
                return;
            }
            
            try {
                const response = await fetch(`/api/report/${extractedData.sessionId}`);
                const result = await response.json();
                
                if (result.success) {
                    renderReport(result.report);
                } else {
                    showError('Errore nella generazione del report');
                }
            } catch (error) {
                console.error('‚ùå Errore generateReport:', error);
                showError('Errore di connessione per il report');
            }
        }

        function renderReport(report) {
            const container = document.getElementById('report-content');
            
            container.innerHTML = `
                <div class="report-summary">
                    <h3>üìã Report IMU 2025 Completo</h3>
                    <p><strong>Generato il:</strong> ${new Date(report.generatedAt).toLocaleDateString('it-IT')}</p>
                    <p><strong>Sessione:</strong> ${report.sessionId}</p>
                </div>

                <div class="report-section">
                    <h4>üìÑ File analizzati:</h4>
                    <ul>
                        ${report.files.map(file => 
                            `<li>${file.name} (${formatFileSize(file.size)})</li>`
                        ).join('')}
                    </ul>
                </div>

                <div class="report-section">
                    <h4>üè† Dati estratti:</h4>
                    <p>‚Ä¢ Fabbricati: ${report.datiEstratti.fabbricati}</p>
                    <p>‚Ä¢ Terreni: ${report.datiEstratti.terreni}</p>
                    <p>‚Ä¢ Confidenza estrazione: ${report.datiEstratti.confidence?.toFixed(1)}%</p>
                </div>

                <div class="report-section">
                    <h4>üí∞ Risultato calcolo:</h4>
                    <div class="total-amount">
                        <strong>Totale IMU 2025: ‚Ç¨${report.calcolo.totalIMU.toFixed(2)}</strong>
                    </div>
                    <div class="schedule">
                        <p>‚Ä¢ Acconto: ‚Ç¨${report.calcolo.acconto.toFixed(2)} (16/06/2025)</p>
                        <p>‚Ä¢ Saldo: ‚Ç¨${report.calcolo.saldo.toFixed(2)} (16/12/2025)</p>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="generatePDF()">
                        üìÑ Genera e Scarica Report PDF
                    </button>
                    <button class="btn btn-secondary" onclick="restart()" style="margin-left: 15px;">
                        üîÑ Nuova Analisi
                    </button>
                </div>
            `;
        }

        async function generatePDF() {
            try {
                // Controllo di sicurezza per sessionId
                if (!extractedData || !extractedData.sessionId) {
                    console.error('‚ùå SessionId mancante in generatePDF');
                    showError('Errore: SessionId mancante. Riprova l\'analisi.');
                    goToStep(1);
                    return;
                }
                
                // Mostra loading
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚è≥ Generando PDF...';
                btn.disabled = true;

                // Genera PDF
                const response = await fetch(`/api/report/${extractedData.sessionId}/pdf`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    // Download automatico
                    window.open(`/api/report/${extractedData.sessionId}/download`, '_blank');
                    showSuccess('‚úÖ PDF generato e scaricato con successo!');
                } else {
                    throw new Error(result.error || 'Errore nella generazione PDF');
                }

                // Ripristina bottone
                btn.innerHTML = originalText;
                btn.disabled = false;

            } catch (error) {
                console.error('‚ùå Errore generazione PDF:', error);
                showError('‚ùå Errore durante la generazione del PDF: ' + error.message);
                
                // Ripristina bottone
                const btn = event.target;
                btn.innerHTML = 'üìÑ Genera e Scarica Report PDF';
                btn.disabled = false;
            }
        }

        function restart() {
            // Reset state
            currentStep = 1;
            uploadedFiles = [];
            extractedData = null;
            userAnswers = {};
            
            // Clear UI
            document.getElementById('file-list').innerHTML = '';
            document.getElementById('progress-container').innerHTML = '';
            document.getElementById('fabbricati-section').innerHTML = '';
            document.getElementById('terreni-section').innerHTML = '';
            document.getElementById('questions-container').innerHTML = '';
            document.getElementById('calculation-results').innerHTML = '';
            document.getElementById('report-content').innerHTML = '';
            
            // Reset analyze button
            document.getElementById('analyze-btn').disabled = true;
            
            // Go to step 1
            goToStep(1);
        }

        function showError(message) {
            alert('‚ùå ' + message);
        }

        function showSuccess(message) {
            alert('‚úÖ ' + message);
        }
    </script>
</body>
</html> 