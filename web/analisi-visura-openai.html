<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisi Visura Catastale Server OpenAI - Domande IMU 2025</title>
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Tesseract.js per OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #10a37f 0%, #1a7f64 100%);
            min-height: 100vh; padding: 20px;
        }
        .container {
            max-width: 1600px; margin: 0 auto; background: white;
            border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(45deg, #10a37f, #1a7f64);
            color: white; padding: 30px; text-align: center;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.2em; opacity: 0.9; }
        .main-content {
            display: grid; grid-template-columns: 450px 1fr;
            gap: 0; min-height: 85vh;
        }
        .upload-section {
            padding: 30px; background: #f8f9fa;
            border-right: 1px solid #e9ecef; overflow-y: auto;
        }
        .results-section {
            padding: 30px; background: white;
            overflow-y: auto; max-height: 85vh;
        }
        .upload-area {
            border: 3px dashed #10a37f; border-radius: 10px;
            padding: 40px 20px; text-align: center;
            background: #f0fdf4; transition: all 0.3s;
            cursor: pointer; margin-bottom: 20px;
        }
        .upload-area.dragover { border-color: #4CAF50; background: #f0fff0; }
        .upload-area:hover { border-color: #0d8a6b; background: #ecfdf5; }
        .btn {
            background: linear-gradient(45deg, #10a37f, #1a7f64);
            color: white; border: none; padding: 12px 25px;
            border-radius: 8px; font-size: 14px; font-weight: 600;
            cursor: pointer; transition: transform 0.2s;
            width: 100%; margin-top: 15px;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .progress-container { margin: 20px 0; }
        .progress-bar {
            width: 100%; height: 8px; background: #e9ecef;
            border-radius: 4px; overflow: hidden; margin: 10px 0;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(45deg, #10a37f, #1a7f64);
            transition: width 0.3s; width: 0%;
        }
        .status {
            padding: 10px; border-radius: 6px;
            margin: 10px 0; font-size: 0.9em;
        }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .property-card {
            background: #f8f9fa; border-radius: 10px; padding: 20px;
            margin-bottom: 25px; border-left: 4px solid #10a37f;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .property-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 15px;
            flex-wrap: wrap; gap: 10px;
        }
        .property-title { font-size: 1.4em; font-weight: 700; color: #2c3e50; }
        .confidence-badge {
            background: #10a37f; color: white; padding: 4px 8px;
            border-radius: 12px; font-size: 0.8em; font-weight: 600;
        }
        .confidence-badge.medium { background: #ffc107; color: #212529; }
        .confidence-badge.low { background: #dc3545; }
        .property-details {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px; margin-bottom: 20px;
        }
        .detail-item {
            background: white; padding: 10px; border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        .detail-label {
            font-weight: 600; color: #7f8c8d;
            font-size: 0.85em; margin-bottom: 4px;
        }
        .detail-value { color: #2c3e50; font-size: 0.95em; }
        .question-group {
            background: white; border-radius: 8px; padding: 15px;
            margin-bottom: 15px; border: 1px solid #e9ecef;
        }
        .group-title {
            font-size: 1.1em; font-weight: 600;
            color: #2c3e50; margin-bottom: 10px;
        }
        .question {
            background: #f8f9fa; border-radius: 6px; padding: 12px;
            margin-bottom: 10px; border-left: 3px solid #10a37f;
        }
        .question-text {
            font-weight: 500; color: #2c3e50; margin-bottom: 8px;
        }
        .question-reason {
            background: #fff3cd; border: 1px solid #ffeaa7;
            border-radius: 4px; padding: 8px;
            font-size: 0.85em; color: #856404;
        }
        .question-disabled {
            opacity: 0.6;
            background: #f8f9fa !important;
            border-left-color: #6c757d !important;
        }
        .input-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 10px 0;
        }
        .input-group label {
            display: flex;
            align-items: center;
            font-size: 0.95em;
            transition: all 0.2s ease;
        }
        .input-group label:hover:not([style*="not-allowed"]) {
            color: #10a37f;
        }
        .input-group input[type="radio"] {
            margin-right: 8px;
            transform: scale(1.1);
        }
        .input-group select {
            font-size: 0.9em;
            transition: border-color 0.2s ease;
        }
        .input-group select:focus {
            outline: none;
            border-color: #10a37f;
            box-shadow: 0 0 0 2px rgba(16, 163, 127, 0.1);
        }
        .disabled-reason {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 8px;
            margin: 8px 0;
            font-size: 0.85em;
            color: #856404;
            animation: fadeIn 0.3s ease;
        }
        .applicable-rates {
            margin-top: 15px;
            padding: 10px;
            background: #f0fdf4;
            border-radius: 6px;
            border-left: 3px solid #10a37f;
            transition: all 0.3s ease;
        }
        .applicable-rates:hover {
            background: #ecfdf5;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .empty-state { text-align: center; color: #7f8c8d; padding: 50px 20px; }
        .extraction-summary {
            background: #f0fdf4; border-radius: 8px; padding: 15px;
            margin-bottom: 20px; border-left: 4px solid #10a37f;
        }
        .summary-title { font-weight: 600; color: #10a37f; margin-bottom: 10px; }
        .openai-info {
            background: #f0fdf4; border: 1px solid #bbf7d0;
            border-radius: 6px; padding: 15px; margin: 15px 0;
            font-size: 0.9em;
        }
        .openai-title { font-weight: 600; color: #15803d; margin-bottom: 8px; }
        .upload-icon { font-size: 3em; color: #10a37f; margin-bottom: 15px; }
        .upload-text { font-size: 1.1em; color: #2c3e50; margin-bottom: 10px; }
        .upload-subtext { color: #7f8c8d; font-size: 0.9em; }
        .file-input { display: none; }
        .api-key-section {
            background: #f0fdf4; border: 1px solid #bbf7d0;
            border-radius: 6px; padding: 15px; margin: 15px 0;
        }
        .api-key-input {
            width: 100%; padding: 8px; border: 1px solid #d1d5db;
            border-radius: 4px; font-family: monospace;
            font-size: 0.9em; margin-top: 8px;
        }
        .debug-section {
            margin-top: 20px; padding: 15px; background: #f1f3f4;
            border-radius: 6px; border-left: 4px solid #6c757d;
        }
        .toggle-debug {
            background: #6c757d; color: white; border: none;
            padding: 6px 12px; border-radius: 4px;
            font-size: 12px; cursor: pointer; margin-bottom: 10px;
        }
        .extracted-text {
            background: #f8f9fa; border: 1px solid #dee2e6;
            border-radius: 6px; padding: 15px; margin: 15px 0;
            max-height: 200px; overflow-y: auto;
            font-family: monospace; font-size: 0.85em; line-height: 1.4;
        }
        .text-preview { color: #6c757d; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Analisi Visura Server OpenAI</h1>
            <p>Intelligenza artificiale GPT server-side - Domande IMU 2025 Torino</p>
        </div>

        <div class="main-content">
            <div class="upload-section">
                <h3 style="margin-bottom: 20px; color: #2c3e50;">üì§ Carica Visura</h3>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ü§ñ</div>
                    <div class="upload-text">Trascina qui le visure catastali</div>
                    <div class="upload-subtext">oppure clicca per selezionare i file</div>
                    <div class="upload-subtext" style="margin-top: 10px; font-weight: 500;">
                        Formati: PDF, JPG, PNG ‚Ä¢ üìÑ Puoi selezionare pi√π file<br>
                        <span style="color: #15803d;">üß† VERA AI SERVER-SIDE</span>
                    </div>
                </div>

                <input type="file" id="fileInput" class="file-input" accept=".pdf,.jpg,.jpeg,.png" multiple>
                
                <div class="progress-container" id="progressContainer" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div id="status" class="status"></div>
                </div>

                <button type="button" class="btn" id="analyzeBtn" disabled>
                    ü§ñ Analizza con Server OpenAI
                </button>

                <div class="openai-info">
                    <div class="openai-title">üß† Server OpenAI Analysis:</div>
                    <ul style="font-size: 0.85em; line-height: 1.6;">
                        <li>üîç Comprende qualsiasi formato di visura</li>
                        <li>üìä Estrae dati con intelligenza contestuale</li>
                        <li>üè† Identifica automaticamente immobili</li>
                        <li>üí° Ragiona sui dati come un esperto</li>
                        <li>üåü Funziona con qualsiasi visura italiana</li>
                        <li>üîí Chiave API sicura lato server</li>
                    </ul>
                </div>

                <div class="debug-section" id="debugSection" style="display: none;">
                    <button class="toggle-debug" onclick="toggleDebug()">üëÅÔ∏è Mostra/Nascondi Debug</button>
                    <div id="debugContent" style="display: none;">
                        <div style="font-weight: 600; color: #495057; margin-bottom: 10px;">üìù Testo Estratto</div>
                        <div class="extracted-text" id="extractedText">
                            <div class="text-preview">Il testo estratto apparir√† qui...</div>
                        </div>
                        <div style="font-weight: 600; color: #495057; margin-bottom: 10px;">ü§ñ Risposta OpenAI</div>
                        <div class="extracted-text" id="openaiResponse">
                            <div class="text-preview">La risposta di OpenAI apparir√† qui...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="results-section">
                <h3 style="margin-bottom: 20px; color: #2c3e50;">üè† Immobili Trovati</h3>
                <div id="results">
                    <div class="empty-state">
                        <h3>Nessuna visura analizzata</h3>
                        <p>Carica una visura catastale per l'<strong>analisi con Server OpenAI GPT</strong>.</p>
                        <br>
                        <p><strong>Vantaggi Server OpenAI:</strong></p>
                        <ul style="text-align: left; display: inline-block; margin-top: 10px;">
                            <li>üß† Vera comprensione del linguaggio naturale</li>
                            <li>üîç Identifica dati anche in formati complessi</li>
                            <li>üìä Struttura automaticamente le informazioni</li>
                            <li>üéØ Precisione superiore ai pattern regex</li>
                            <li>üöÄ Si adatta a qualsiasi tipo di visura</li>
                            <li>üîí Chiave API sicura e protetta server-side</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Configurazione PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Dati IMU Torino 2025
        const imuRatesTorinoTO2025 = [
            {
                label: "Abitazione principale A/1, A/8, A/9 e relative pertinenze",
                ratePercent: 0.006,
                categoryTypes: ["A/1", "A/8", "A/9", "C/2", "C/6", "C/7"]
            },
            {
                label: "Fabbricati gruppo D (escluso D/10)",
                ratePercent: 0.0106,
                categoryTypes: ["D/1", "D/2", "D/3", "D/4", "D/5", "D/6", "D/7", "D/8", "D/9"]
            },
            {
                label: "Fabbricato ordinario (no abitazione principale n√© gruppo D)",
                ratePercent: 0.0106,
                categoryTypes: ["A/2", "A/3", "A/4", "A/5", "A/6", "A/7"]
            },
            {
                label: "Area fabbricabile",
                ratePercent: 0.0096
            },
            {
                label: "Abitazione locata a canone concordato",
                ratePercent: 0.00575,
                categoryTypes: ["A/2", "A/3", "A/4", "A/5", "A/6", "A/7"]
            }
        ];

        class OpenAIVisuraCatastaleAnalyzer {
            constructor() {
                this.extractedText = '';
                this.properties = [];
                this.openaiResponse = '';
            }

            async analyzeFile(file) {
                this.updateProgress(10, "Inizializzazione...");
                
                try {
                    // Step 1: Estrazione testo
                    if (file.type === 'application/pdf') {
                        this.extractedText = await this.extractTextFromPDF(file);
                    } else if (file.type.startsWith('image/')) {
                        this.extractedText = await this.extractTextFromImage(file);
                    } else {
                        throw new Error('Formato file non supportato');
                    }

                    this.updateProgress(50, "Invio a OpenAI...");
                    
                    // Step 2: Analisi con OpenAI
                    this.properties = await this.analyzeWithOpenAI(this.extractedText);
                    
                    this.updateProgress(100, "Analisi OpenAI completata!");
                    
                    return {
                        text: this.extractedText,
                        properties: this.properties,
                        openaiResponse: this.openaiResponse
                    };

                } catch (error) {
                    this.showStatus(`Errore: ${error.message}`, 'error');
                    throw error;
                }
            }

            async extractTextFromPDF(file) {
                this.updateProgress(20, "Caricamento PDF...");
                
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                let fullText = '';
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    this.updateProgress(20 + (i / pdf.numPages) * 20, `Elaborazione pagina ${i}/${pdf.numPages}...`);
                    
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n\n';
                }
                
                return fullText;
            }

            async extractTextFromImage(file) {
                this.updateProgress(20, "Inizializzazione OCR...");
                
                return new Promise((resolve, reject) => {
                    Tesseract.recognize(file, 'ita', {
                        logger: (info) => {
                            if (info.status === 'recognizing text') {
                                const progress = Math.round(info.progress * 20);
                                this.updateProgress(20 + progress, `OCR in corso: ${Math.round(info.progress * 100)}%`);
                            }
                        }
                    }).then(({ data: { text } }) => {
                        resolve(text);
                    }).catch(reject);
                });
            }

            async analyzeWithOpenAI(text) {
                this.updateProgress(60, "Server sta analizzando con OpenAI...");
                
                try {
                    const response = await fetch('/api/openai-analyze', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            text: text
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Server Error: ${errorData.error || 'Errore sconosciuto'}`);
                    }

                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error(data.error || 'Errore nell\'analisi server');
                    }
                    
                    this.openaiResponse = data.rawResponse || 'Risposta non disponibile';
                    
                    this.updateProgress(90, "Parsing risposta server...");
                    
                    return data.properties || [];

                } catch (error) {
                    console.error('Errore chiamata server OpenAI:', error);
                    throw error;
                }
            }

            updateProgress(percentage, message) {
                const progressFill = document.getElementById('progressFill');
                if (progressFill) {
                    progressFill.style.width = `${percentage}%`;
                }
                this.showStatus(message, 'info');
            }

            showStatus(message, type) {
                const status = document.getElementById('status');
                if (status) {
                    status.textContent = message;
                    status.className = `status ${type}`;
                }
            }
        }

        class TorinIMUQuestionGenerator {
            constructor() {
                this.rates = imuRatesTorinoTO2025;
                this.propertyAnswers = new Map(); // Stato delle risposte per ogni immobile
                this.globalState = {
                    mainResidencePropertyId: null // Traccia quale immobile √® l'abitazione principale
                };
            }

            generateQuestions(property) {
                const potentialRates = this.findPotentialRates(property);
                const questionGroups = [];

                const basicQuestions = this.generateBasicQuestions(property, potentialRates);
                if (basicQuestions.questions.length > 0) {
                    questionGroups.push(basicQuestions);
                }

                return questionGroups;
            }

            findPotentialRates(property) {
                return this.rates.filter(rate => {
                    // Esclude "Area fabbricabile" per i fabbricati (solo per terreni)
                    if (rate.label.includes('Area fabbricabile') && property.type === 'fabbricato') {
                        return false;
                    }
                    
                    if (rate.categoryTypes && property.categoria && property.categoria !== 'Non specificato') {
                        return rate.categoryTypes.includes(property.categoria);
                    }
                    return true;
                });
            }

            generateBasicQuestions(property, potentialRates) {
                const questions = [];
                const answers = this.propertyAnswers.get(property.id) || {};

                if (property.type === 'fabbricato') {
                    // Domanda per abitazione principale (solo per categorie A)
                    if (this.isCategoryA(property.categoria)) {
                        questions.push({
                            id: 'isMainResidence',
                            text: 'Questo immobile √® indicato come abitazione principale del proprietario?',
                            type: 'boolean',
                            required: true,
                            disabled: this.isMainResidenceDisabled(property.id),
                            reason: 'Per determinare se applicare l\'aliquota agevolata per abitazione principale'
                        });

                        // Domande sulla locazione (solo se NON √® abitazione principale)
                        if (!answers.isMainResidence) {
                            questions.push({
                                id: 'isRented',
                                text: 'L\'immobile √® dato in locazione?',
                                type: 'boolean',
                                required: false,
                                disabled: answers.isMainResidence === true,
                                reason: 'Alcuni tipi di locazione hanno aliquote agevolate'
                            });

                            // Domanda sul tipo di contratto (solo se in locazione)
                            if (answers.isRented) {
                                questions.push({
                                    id: 'contractType',
                                    text: 'Se in locazione, che tipo di contratto √®?',
                                    type: 'select',
                                    options: [
                                        { value: 'canone_concordato', label: 'Canone concordato' },
                                        { value: 'studenti', label: 'Studenti universitari' },
                                        { value: 'transitorio', label: 'Transitorio' },
                                        { value: 'libero', label: 'Libero mercato' }
                                    ],
                                    required: true,
                                    reason: 'I contratti a canone concordato, per studenti e transitori hanno aliquote agevolate'
                                });
                            }
                        }
                    }

                    // Domanda per pertinenze (solo per categorie C/2, C/6, C/7)
                    if (this.isCategoryC(property.categoria)) {
                        const categoryAProperties = this.getCategoryAPropertiesInSameCommune(property);
                        
                        if (categoryAProperties.length > 0) {
                            questions.push({
                                id: 'isAppurtenance',
                                text: 'Questo immobile √® una pertinenza?',
                                type: 'boolean',
                                required: true,
                                reason: 'Le pertinenze dell\'abitazione principale sono esenti da IMU'
                            });

                            if (answers.isAppurtenance) {
                                questions.push({
                                    id: 'appurtenanceOf',
                                    text: 'Di quale abitazione principale √® pertinenza?',
                                    type: 'select',
                                    options: categoryAProperties.map(p => ({
                                        value: p.id,
                                        label: `${this.getPropertyDisplayName(p)} (${p.categoria})`
                                    })),
                                    required: true,
                                    reason: 'Specifica a quale abitazione principale appartiene questa pertinenza'
                                });
                            }
                        }

                        // Domande sulla locazione (solo se NON √® pertinenza)
                        if (!answers.isAppurtenance) {
                            questions.push({
                                id: 'isRented',
                                text: 'L\'immobile √® dato in locazione?',
                                type: 'boolean',
                                required: false,
                                disabled: answers.isAppurtenance === true,
                                reason: 'Alcuni tipi di locazione hanno aliquote agevolate'
                            });

                            // Domanda sul tipo di contratto (solo se in locazione)
                            if (answers.isRented) {
                                questions.push({
                                    id: 'contractType',
                                    text: 'Se in locazione, che tipo di contratto √®?',
                                    type: 'select',
                                    options: [
                                        { value: 'canone_concordato', label: 'Canone concordato' },
                                        { value: 'studenti', label: 'Studenti universitari' },  
                                        { value: 'transitorio', label: 'Transitorio' },
                                        { value: 'libero', label: 'Libero mercato' }
                                    ],
                                    required: true,
                                    reason: 'I contratti a canone concordato, per studenti e transitori hanno aliquote agevolate'
                                });
                            }
                        }
                    }

                    // Per tutti gli altri fabbricati (C/1, C/3, C/4, C/5, B, D, etc.) - solo domande locazione
                    if (!this.isCategoryA(property.categoria) && !this.isCategoryC(property.categoria)) {
                        questions.push({
                            id: 'isRented',
                            text: 'L\'immobile √® dato in locazione?',
                            type: 'boolean',
                            required: false,
                            reason: 'Alcuni tipi di locazione hanno aliquote agevolate'
                        });

                        // Domanda sul tipo di contratto (solo se in locazione)
                        if (answers.isRented) {
                            questions.push({
                                id: 'contractType',
                                text: 'Se in locazione, che tipo di contratto √®?',
                                type: 'select',
                                options: [
                                    { value: 'canone_concordato', label: 'Canone concordato' },
                                    { value: 'studenti', label: 'Studenti universitari' },  
                                    { value: 'transitorio', label: 'Transitorio' },
                                    { value: 'libero', label: 'Libero mercato' }
                                ],
                                required: true,
                                reason: 'I contratti a canone concordato, per studenti e transitori hanno aliquote agevolate'
                            });
                        }
                    }
                }

                return {
                    title: 'Informazioni necessarie per IMU',
                    description: 'Domande per determinare l\'aliquota corretta',
                    questions,
                    applicableRates: potentialRates.map(r => r.label)
                };
            }

            // Metodi di supporto
            isCategoryA(categoria) {
                return categoria && categoria.startsWith('A/');
            }

            isCategoryC(categoria) {
                return ['C/2', 'C/6', 'C/7'].includes(categoria);
            }

            isMainResidenceDisabled(propertyId) {
                // Disabilita se un altro immobile √® gi√† abitazione principale
                return this.globalState.mainResidencePropertyId && 
                       this.globalState.mainResidencePropertyId !== propertyId;
            }

            getCategoryAPropertiesInSameCommune(currentProperty) {
                if (!analysisResults || !analysisResults.properties) return [];
                
                return analysisResults.properties.filter(p => 
                    p.id !== currentProperty.id &&
                    this.isCategoryA(p.categoria) &&
                    p.comune === currentProperty.comune
                );
            }

            // Nuovo metodo per ottenere descrizione intelligente dell'immobile
            getPropertyDescription(property) {
                const categoria = property.categoria || 'N/D';
                const comune = property.comune || 'N/D';
                
                const descrizioni = {
                    'A/1': 'Abitazione signorile',
                    'A/2': 'Abitazione civile', 
                    'A/3': 'Abitazione economica',
                    'A/4': 'Abitazione popolare',
                    'A/5': 'Abitazione ultrapopolare',
                    'A/6': 'Abitazione rurale',
                    'A/7': 'Abitazione in villini',
                    'A/8': 'Abitazione ville',
                    'A/9': 'Castelli e palazzi storici',
                    'A/10': 'Uffici e studi privati',
                    'A/11': 'Abitazioni tipiche dei luoghi',
                    'B/1': 'Collegi e convitti',
                    'B/2': 'Case di cura e ospedali',
                    'B/3': 'Prigioni e riformatori',
                    'B/4': 'Uffici pubblici',
                    'B/5': 'Scuole e laboratori scientifici',
                    'B/6': 'Biblioteche e musei',
                    'B/7': 'Cappelle e oratori',
                    'B/8': 'Magazzini sotterranei',
                    'C/1': 'Negozi e botteghe',
                    'C/2': 'Magazzini e locali deposito',
                    'C/3': 'Laboratori per arti e mestieri',
                    'C/4': 'Fabbricati per funzioni produttive',
                    'C/5': 'Stabilimenti balneari',
                    'C/6': 'Autorimesse e scuderie',
                    'C/7': 'Tettoie chiuse o aperte',
                    'D/1': 'Opifici',
                    'D/2': 'Alberghi e pensioni',
                    'D/3': 'Teatri e cinema',
                    'D/4': 'Case di cura private',
                    'D/5': 'Istituti di credito',
                    'D/6': 'Fabbricati per esercizi sportivi',
                    'D/7': 'Fabbricati costruiti per attivit√† industriali',
                    'D/8': 'Fabbricati costruiti per attivit√† commerciali',
                    'D/9': 'Edifici galleggianti',
                    'D/10': 'Fabbricati per funzioni produttive connesse alle attivit√† agricole'
                };
                
                const descrizione = descrizioni[categoria] || `Immobile categoria ${categoria}`;
                return `${descrizione} a ${comune}`;
            }

            // Metodo per ottenere nome leggibile dell'immobile (gi√† esistente)
            getPropertyDisplayName(property) {
                if (property.indirizzo && property.indirizzo !== 'Non specificato') {
                    let address = property.indirizzo;
                    
                    // Rimuovi il prefetto del comune se presente
                    address = address.replace(/^[A-Z]+\([A-Z]{2}\)\s*/, '');
                    
                    // Estrae via e numero dall'indirizzo
                    const patterns = [
                        /VIA\s+([^n\.]+)\s*n?\.\s*(\d+)/i,
                        /PIAZZA\s+([^n\.]+)\s*n?\.\s*(\d+)/i,
                        /CORSO\s+([^n\.]+)\s*n?\.\s*(\d+)/i,
                        /VIALE\s+([^n\.]+)\s*n?\.\s*(\d+)/i,
                        /(VIA|PIAZZA|CORSO|VIALE)\s+([^0-9]+)\s*(\d+)/i
                    ];
                    
                    for (const pattern of patterns) {
                        const match = address.match(pattern);
                        if (match) {
                            const tipo = match[1].toUpperCase() === match[1] ? match[1] : 'Via';
                            const nome = match[2].trim();
                            const numero = match[3] || match[2].match(/\d+$/)?.[0] || '';
                            return `${tipo} ${nome} ${numero}`.trim();
                        }
                    }
                    
                    // Fallback: tenta di estrarre almeno via + numero
                    const simpleMatch = address.match(/([A-Za-z\s]+)\s*(\d+)/);
                    if (simpleMatch) {
                        return `${simpleMatch[1].trim()} ${simpleMatch[2]}`;
                    }
                    
                    // Ultimo fallback: primi 40 caratteri
                    return address.length > 40 ? address.substring(0, 40) + '...' : address;
                }
                
                return `Immobile ${property.categoria || 'N/D'}`;
            }

            // Gestione delle risposte
            setAnswer(propertyId, questionId, value) {
                if (!this.propertyAnswers.has(propertyId)) {
                    this.propertyAnswers.set(propertyId, {});
                }
                
                const answers = this.propertyAnswers.get(propertyId);
                const oldValue = answers[questionId];
                answers[questionId] = value;

                // Gestione stato globale abitazione principale
                if (questionId === 'isMainResidence') {
                    if (value === true) {
                        // Imposta questo come abitazione principale
                        this.globalState.mainResidencePropertyId = propertyId;
                        // Rimuovi locazione se era selezionata
                        answers.isRented = false;
                        answers.contractType = null;
                    } else if (oldValue === true) {
                        // Rimuovi abitazione principale
                        this.globalState.mainResidencePropertyId = null;
                    }
                }

                // Gestione pertinenze
                if (questionId === 'isAppurtenance') {
                    if (value === true) {
                        // Rimuovi locazione se era selezionata
                        answers.isRented = false;
                        answers.contractType = null;
                    } else {
                        // Rimuovi la selezione dell'immobile di appartenenza
                        answers.appurtenanceOf = null;
                    }
                }

                // Gestione locazione
                if (questionId === 'isRented' && value === false) {
                    // Rimuovi tipo contratto se non in locazione
                    answers.contractType = null;
                }

                // Rigenera le domande per tutti gli immobili
                this.refreshAllQuestions();
            }

            getAnswer(propertyId, questionId) {
                const answers = this.propertyAnswers.get(propertyId);
                return answers ? answers[questionId] : undefined;
            }

            refreshAllQuestions() {
                // Rigenera le domande per tutti gli immobili visualizzati
                if (analysisResults && analysisResults.properties) {
                    displayResults(analysisResults.properties);
                    updateCalculateButton();
                }
            }

            // Nuovo metodo per verificare se tutte le domande obbligatorie sono state risposte
            areAllRequiredQuestionsAnswered() {
                if (!analysisResults || !analysisResults.properties) return false;
                
                for (const property of analysisResults.properties) {
                    const questionGroups = this.generateQuestions(property);
                    for (const group of questionGroups) {
                        for (const question of group.questions) {
                            if (question.required && !question.disabled) {
                                const answer = this.getAnswer(property.id, question.id);
                                if (answer === undefined || answer === null) {
                                    return false;
                                }
                            }
                        }
                    }
                }
                return true;
            }
        }

        // Inizializzazione
        const analyzer = new OpenAIVisuraCatastaleAnalyzer();
        const questionGenerator = new TorinIMUQuestionGenerator();
        let currentFiles = []; // Array di file invece di singolo file
        let analysisResults = null;

        // DOM elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const progressContainer = document.getElementById('progressContainer');
        const results = document.getElementById('results');
        const debugSection = document.getElementById('debugSection');
        const extractedText = document.getElementById('extractedText');
        const openaiResponse = document.getElementById('openaiResponse');

        // Event listeners
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        uploadArea.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);
        analyzeBtn.addEventListener('click', analyzeFile);

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) {
                handleFiles(files);
            }
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                handleFiles(files);
            }
        }

        function handleFiles(files) {
            currentFiles = files;
            const totalSize = files.reduce((sum, file) => sum + file.size, 0);
            const fileNames = files.map(f => f.name).join(', ');
            
            analyzer.showStatus(`${files.length} file selezionati: ${fileNames} (${(totalSize/1024/1024).toFixed(2)} MB totali)`, 'info');
            updateAnalyzeButton();
        }

        function updateAnalyzeButton() {
            const hasFiles = currentFiles.length > 0;
            analyzeBtn.disabled = !hasFiles;
            
            if (hasFiles) {
                if (currentFiles.length === 1) {
                    analyzeBtn.innerHTML = `ü§ñ Analizza ${currentFiles[0].name} con Server`;
                } else {
                    analyzeBtn.innerHTML = `ü§ñ Analizza ${currentFiles.length} file con Server`;
                }
            } else {
                analyzeBtn.innerHTML = 'üìÑ Seleziona file per analisi';
            }
        }

        async function analyzeFile() {
            if (currentFiles.length === 0) return;

            analyzeBtn.disabled = true;
            progressContainer.style.display = 'block';
            debugSection.style.display = 'block';
            
            try {
                // Combina tutti i file in un unico testo per l'analisi
                let combinedText = '';
                
                for (let i = 0; i < currentFiles.length; i++) {
                    const file = currentFiles[i];
                    analyzer.updateProgress(10 + (i / currentFiles.length) * 40, `Elaborazione file ${i + 1}/${currentFiles.length}: ${file.name}...`);
                    
                    let fileText = '';
                    if (file.type === 'application/pdf') {
                        fileText = await analyzer.extractTextFromPDF(file);
                    } else if (file.type.startsWith('image/')) {
                        fileText = await analyzer.extractTextFromImage(file);
                    } else {
                        throw new Error(`Formato file non supportato: ${file.type}`);
                    }
                    
                    combinedText += `\n\n=== FILE: ${file.name} ===\n${fileText}\n=== FINE FILE ===\n`;
                }
                
                analyzer.extractedText = combinedText;
                analyzer.updateProgress(50, "Invio testo combinato a OpenAI...");
                
                // Analizza il testo combinato con OpenAI
                const properties = await analyzer.analyzeWithOpenAI(combinedText);
                
                analysisResults = {
                    text: combinedText,
                    properties: properties,
                    openaiResponse: analyzer.openaiResponse
                };
                
                // Mostra testo estratto
                extractedText.innerHTML = `<div class="text-preview">${combinedText.substring(0, 2000)}${combinedText.length > 2000 ? '...\n\n[Testo completo disponibile per debug]' : ''}</div>`;
                
                // Mostra risposta OpenAI
                openaiResponse.innerHTML = `<div class="text-preview">${analysisResults.openaiResponse}</div>`;
                
                // Mostra risultati
                displayResults(analysisResults.properties);
                
                analyzer.showStatus(`‚úÖ Analisi Server completata! Elaborati ${currentFiles.length} file, trovati ${analysisResults.properties.length} immobili.`, 'success');
                
            } catch (error) {
                analyzer.showStatus(`‚ùå Errore: ${error.message}`, 'error');
                console.error(error);
            } finally {
                updateAnalyzeButton();
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 2000);
            }
        }

        function displayResults(properties) {
            if (properties.length === 0) {
                results.innerHTML = `
                    <div class="empty-state">
                        <h3>‚ùå Nessun immobile trovato</h3>
                        <p>OpenAI non √® riuscito a identificare dati catastali nel file.</p>
                        <p style="margin-top: 15px;">
                            <button class="toggle-debug" onclick="toggleDebug()">üëÅÔ∏è Visualizza debug completo</button>
                        </p>
                    </div>
                `;
                return;
            }

            // Ordina immobili per comune alfabetico e poi per categoria
            const sortedProperties = [...properties].sort((a, b) => {
                // Prima per comune
                const comuneA = (a.comune || '').toLowerCase();
                const comuneB = (b.comune || '').toLowerCase();
                if (comuneA !== comuneB) {
                    return comuneA.localeCompare(comuneB);
                }
                
                // Poi per categoria
                const catA = a.categoria || '';
                const catB = b.categoria || '';
                return catA.localeCompare(catB);
            });

            let html = generateSummary(sortedProperties);

            sortedProperties.forEach(property => {
                const questionGroups = questionGenerator.generateQuestions(property);
                html += generatePropertyCard(property, questionGroups);
            });

            results.innerHTML = html;
        }

        function generateSummary(properties) {
            const avgConfidence = Math.round(properties.reduce((sum, p) => sum + p.confidence, 0) / properties.length);

            return `
                <div class="extraction-summary">
                    <div class="summary-title">ü§ñ Risultati Analisi OpenAI</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                        <div style="text-align: center; background: white; padding: 10px; border-radius: 6px;">
                            <div style="font-size: 1.5em; font-weight: 700; color: #10a37f;">${properties.length}</div>
                            <div style="font-size: 0.85em; color: #7f8c8d;">Immobili estratti</div>
                        </div>
                        <div style="text-align: center; background: white; padding: 10px; border-radius: 6px;">
                            <div style="font-size: 1.5em; font-weight: 700; color: #10a37f;">${avgConfidence}%</div>
                            <div style="font-size: 0.85em; color: #7f8c8d;">Confidenza OpenAI</div>
                        </div>
                    </div>
                    <div id="imuCalculationSection" style="margin-top: 20px;">
                        <button id="calculateImuBtn" class="btn" onclick="calculateIMU()" disabled style="background: #6c757d;">
                            üí∞ Calcola IMU 2025
                        </button>
                        <div id="imuResults" style="display: none; margin-top: 20px;">
                            <!-- I risultati del calcolo IMU appariranno qui -->
                        </div>
                    </div>
                </div>
            `;
        }

        function generatePropertyCard(property, questionGroups) {
            const displayName = questionGenerator.getPropertyDisplayName(property);
            const description = questionGenerator.getPropertyDescription(property);
            
            let html = `
                <div class="property-card" data-property-id="${property.id}">
                    <div class="property-header">
                        <div class="property-title">
                            ${property.type === 'fabbricato' ? 'üè†' : 'üåæ'} ${description}
                            <div style="font-size: 0.8em; color: #7f8c8d; font-weight: 400; margin-top: 4px;">
                                ${displayName}
                            </div>
                        </div>
                    </div>
                    
                    <div class="property-details">
                        <div class="detail-item">
                            <div class="detail-label">Titolarit√†</div>
                            <div class="detail-value">${property.titolarita}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Comune</div>
                            <div class="detail-value">${property.comune}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Foglio</div>
                            <div class="detail-value">${property.foglio}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Particella</div>
                            <div class="detail-value">${property.particella}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Subalterno</div>
                            <div class="detail-value">${property.subalterno}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Indirizzo</div>
                            <div class="detail-value">${property.indirizzo}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Zona</div>
                            <div class="detail-value">${property.zona}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Categoria</div>
                            <div class="detail-value">${property.categoria}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Classe</div>
                            <div class="detail-value">${property.classe}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Consistenza</div>
                            <div class="detail-value">${property.consistenza}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Rendita</div>
                            <div class="detail-value">${property.rendita}</div>
                        </div>
                    </div>
            `;

            if (questionGroups.length > 0) {
                questionGroups.forEach(group => {
                    html += `
                        <div class="question-group">
                            <div class="group-title">üìã ${group.title}</div>
                            <div class="group-description" style="font-size: 0.9em; color: #7f8c8d; margin-bottom: 15px;">
                                ${group.description}
                            </div>
                    `;

                    group.questions.forEach(question => {
                        html += generateQuestionHTML(property.id, question);
                    });

                    html += `
                            <div class="applicable-rates" style="margin-top: 15px; padding: 10px; background: #f0fdf4; border-radius: 6px; border-left: 3px solid #10a37f;">
                                <div style="font-weight: 600; color: #10a37f; margin-bottom: 5px;">üí∞ Aliquote potenzialmente applicabili:</div>
                                <ul style="margin: 0; padding-left: 20px;">
                                    ${group.applicableRates.map(rate => `<li style="color: #2c3e50; font-size: 0.9em;">${rate}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                });
            }

            html += '</div>';
            return html;
        }

        function generateQuestionHTML(propertyId, question) {
            const currentValue = questionGenerator.getAnswer(propertyId, question.id);
            const isDisabled = question.disabled || false;
            const disabledClass = isDisabled ? 'question-disabled' : '';
            const disabledReason = getDisabledReason(propertyId, question);

            let html = `
                <div class="question ${disabledClass}" data-question-id="${question.id}">
                    <div class="question-text">
                        ${question.required ? '‚ùó' : '‚ùì'} ${question.text}
                        ${isDisabled ? '<span style="color: #dc3545; font-size: 0.8em; margin-left: 10px;">üö´ DISABILITATA</span>' : ''}
                    </div>
            `;

            if (isDisabled && disabledReason) {
                html += `
                    <div class="disabled-reason" style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 8px; margin: 8px 0; font-size: 0.85em; color: #856404;">
                        <strong>üö´ Motivo disabilitazione:</strong> ${disabledReason}
                    </div>
                `;
            }

            // Genera i controlli input basati sul tipo di domanda
            if (question.type === 'boolean') {
                html += generateBooleanInput(propertyId, question.id, currentValue, isDisabled);
            } else if (question.type === 'select') {
                html += generateSelectInput(propertyId, question.id, question.options, currentValue, isDisabled);
            }

            html += `
                    <div class="question-reason">
                        <strong>üí° Motivo:</strong> ${question.reason}
                    </div>
                </div>
            `;

            return html;
        }

        function generateBooleanInput(propertyId, questionId, currentValue, isDisabled) {
            const name = `${propertyId}_${questionId}`;
            const disabledAttr = isDisabled ? 'disabled' : '';
            
            return `
                <div class="input-group" style="margin: 10px 0;">
                    <label style="display: flex; align-items: center; margin-right: 20px; cursor: ${isDisabled ? 'not-allowed' : 'pointer'};">
                        <input type="radio" name="${name}" value="true" 
                               ${currentValue === true ? 'checked' : ''} 
                               ${disabledAttr}
                               onchange="handleAnswerChange('${propertyId}', '${questionId}', true)"
                               style="margin-right: 8px; ${isDisabled ? 'opacity: 0.5;' : ''}"
                        >
                        <span style="color: ${isDisabled ? '#999' : '#2c3e50'};">‚úÖ S√¨</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: ${isDisabled ? 'not-allowed' : 'pointer'};">
                        <input type="radio" name="${name}" value="false" 
                               ${currentValue === false ? 'checked' : ''} 
                               ${disabledAttr}
                               onchange="handleAnswerChange('${propertyId}', '${questionId}', false)"
                               style="margin-right: 8px; ${isDisabled ? 'opacity: 0.5;' : ''}"
                        >
                        <span style="color: ${isDisabled ? '#999' : '#2c3e50'};">‚ùå No</span>
                    </label>
                </div>
            `;
        }

        function generateSelectInput(propertyId, questionId, options, currentValue, isDisabled) {
            const disabledAttr = isDisabled ? 'disabled' : '';
            
            let html = `
                <div class="input-group" style="margin: 10px 0;">
                    <select onchange="handleAnswerChange('${propertyId}', '${questionId}', this.value)" 
                            ${disabledAttr}
                            style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; background: white; ${isDisabled ? 'opacity: 0.5; cursor: not-allowed;' : ''}"
                    >
                        <option value="">-- Seleziona un'opzione --</option>
            `;

            options.forEach(option => {
                const value = typeof option === 'string' ? option : option.value;
                const label = typeof option === 'string' ? option : option.label;
                const selected = currentValue === value ? 'selected' : '';
                html += `<option value="${value}" ${selected}>${label}</option>`;
            });

            html += `
                    </select>
                </div>
            `;

            return html;
        }

        function getDisabledReason(propertyId, question) {
            if (question.id === 'isMainResidence' && question.disabled) {
                const mainResidenceId = questionGenerator.globalState.mainResidencePropertyId;
                return `Un altro immobile (${mainResidenceId}) √® gi√† stato indicato come abitazione principale. Puoi avere una sola abitazione principale.`;
            }
            
            if (question.id === 'isRented' && question.disabled) {
                const answers = questionGenerator.propertyAnswers.get(propertyId) || {};
                if (answers.isMainResidence) {
                    return 'Un immobile che √® abitazione principale non pu√≤ essere contemporaneamente dato in locazione.';
                }
                if (answers.isAppurtenance) {
                    return 'Un immobile che √® pertinenza di un\'abitazione non pu√≤ essere dato in locazione separatamente.';
                }
            }
            
            return null;
        }

        // Gestore globale per le risposte
        window.handleAnswerChange = function(propertyId, questionId, value) {
            // Converti la stringa in boolean se necessario
            if (value === 'true') value = true;
            if (value === 'false') value = false;
            if (value === '') value = null;
            
            questionGenerator.setAnswer(propertyId, questionId, value);
        };

        // Funzione per aggiornare lo stato del pulsante calcola IMU
        window.updateCalculateButton = function() {
            const calculateBtn = document.getElementById('calculateImuBtn');
            if (calculateBtn && questionGenerator.areAllRequiredQuestionsAnswered()) {
                calculateBtn.disabled = false;
                calculateBtn.style.background = 'linear-gradient(45deg, #10a37f, #1a7f64)';
                calculateBtn.innerHTML = 'üí∞ Calcola IMU 2025';
            } else if (calculateBtn) {
                calculateBtn.disabled = true;
                calculateBtn.style.background = '#6c757d';
                calculateBtn.innerHTML = 'üí∞ Completa le domande per calcolare IMU';
            }
        };

        // Funzione per calcolare l'IMU
        window.calculateIMU = function() {
            if (!analysisResults || !questionGenerator.areAllRequiredQuestionsAnswered()) {
                alert('‚ùå Completa tutte le domande obbligatorie prima di calcolare l\'IMU');
                return;
            }

            // Mostra loading
            const calculateBtn = document.getElementById('calculateImuBtn');
            const originalText = calculateBtn.innerHTML;
            calculateBtn.innerHTML = '‚è≥ Calcolo in corso...';
            calculateBtn.disabled = true;

            // Simula calcolo (da implementare con logica reale)
            setTimeout(() => {
                const imuResults = performIMUCalculation();
                displayIMUResults(imuResults);
                
                calculateBtn.innerHTML = originalText;
                calculateBtn.disabled = false;
            }, 1000);
        };

        // Funzione per eseguire il calcolo IMU
        function performIMUCalculation() {
            const results = {
                totalIMU: 0,
                acconto: 0,
                saldo: 0,
                details: [],
                scadenze: [],
                normativa: []
            };

            for (const property of analysisResults.properties) {
                const answers = questionGenerator.propertyAnswers.get(property.id) || {};
                
                // Logica di calcolo basata sulle risposte
                let baseImponibile = 0;
                let aliquota = 0;
                let detrazione = 0;
                let importoIMU = 0;
                let tipoCalculazione = '';

                // Calcola base imponibile
                const rendita = parseFloat(property.rendita?.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
                const moltiplicatore = getMoltiplicatoreByCat(property.categoria);
                baseImponibile = rendita * 1.05 * moltiplicatore;

                // Determina aliquota e detrazione in base alle risposte
                if (answers.isMainResidence && questionGenerator.isCategoryA(property.categoria)) {
                    // Abitazione principale
                    if (['A/1', 'A/8', 'A/9'].includes(property.categoria)) {
                        aliquota = 0.4; // Abitazioni di lusso
                        detrazione = 200;
                        tipoCalculazione = 'Abitazione principale di lusso';
                    } else {
                        aliquota = 0;
                        detrazione = 0;
                        tipoCalculazione = 'Abitazione principale (ESENTE)';
                    }
                } else if (answers.isAppurtenance) {
                    // Pertinenza
                    aliquota = 0;
                    detrazione = 0;
                    tipoCalculazione = 'Pertinenza abitazione principale (ESENTE)';
                } else if (answers.isRented && answers.contractType === 'canone_concordato') {
                    // Locazione a canone concordato
                    aliquota = 0.575;
                    tipoCalculazione = 'Locazione canone concordato';
                } else {
                    // Altri casi
                    aliquota = 1.06;
                    tipoCalculazione = 'Immobile ordinario';
                }

                importoIMU = Math.max(0, (baseImponibile * aliquota / 100) - detrazione);

                results.details.push({
                    immobile: questionGenerator.getPropertyDescription(property),
                    indirizzo: questionGenerator.getPropertyDisplayName(property),
                    categoria: property.categoria,
                    baseImponibile,
                    aliquota,
                    detrazione,
                    importo: importoIMU,
                    tipo: tipoCalculazione
                });

                results.totalIMU += importoIMU;
            }

            results.acconto = results.totalIMU / 2;
            results.saldo = results.totalIMU / 2;

            // Scadenze
            results.scadenze = [
                { data: '16/06/2025', descrizione: 'Acconto IMU', importo: results.acconto },
                { data: '16/12/2025', descrizione: 'Saldo IMU', importo: results.saldo }
            ];

            // Normativa applicata
            results.normativa = [
                '‚úÖ Rivalutazione catastale applicata (+5%)',
                '‚úÖ Moltiplicatori catastali 2025',
                '‚úÖ Abitazioni principali: ESENTI (tranne A/1, A/8, A/9)',
                '‚úÖ Pertinenze abitazione principale: ESENTI',
                '‚úÖ Canone concordato: aliquota agevolata 0,575%',
                '‚öñÔ∏è D.Lgs. 504/1992 e successive modificazioni'
            ];

            return results;
        }

        // Funzione helper per ottenere moltiplicatori catastali
        function getMoltiplicatoreByCat(categoria) {
            const moltiplicatori = {
                'A/1': 176, 'A/8': 176, 'A/9': 176,
                'A/2': 126, 'A/3': 126, 'A/4': 126, 'A/5': 126, 'A/6': 126, 'A/7': 126,
                'A/10': 63, 'A/11': 63,
                'C/1': 63, 'C/2': 140, 'C/3': 140, 'C/4': 140, 'C/5': 140,
                'C/6': 53, 'C/7': 53,
                'B/1': 176, 'B/2': 176, 'B/3': 176, 'B/4': 176, 'B/5': 176, 'B/6': 176, 'B/7': 176, 'B/8': 176,
                'D/1': 63, 'D/2': 63, 'D/3': 63, 'D/4': 63, 'D/5': 63, 'D/6': 63, 'D/7': 63, 'D/8': 63, 'D/9': 63, 'D/10': 26
            };
            return moltiplicatori[categoria] || 126;
        }

        // Funzione per mostrare i risultati del calcolo IMU
        function displayIMUResults(results) {
            const imuResultsDiv = document.getElementById('imuResults');
            const isEsente = results.totalIMU === 0;
            
            let html = `
                <div class="imu-results-summary" style="background: ${isEsente ? '#d4edda' : '#f8f9fa'}; border: 2px solid ${isEsente ? '#28a745' : '#10a37f'}; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: ${isEsente ? '#155724' : '#10a37f'}; margin-bottom: 15px;">
                        ${isEsente ? '‚úÖ NESSUN PAGAMENTO DOVUTO' : 'üí∞ Calcolo IMU 2025'}
                    </h3>
                    <div style="font-size: 2.5em; font-weight: bold; color: ${isEsente ? '#28a745' : '#dc3545'}; text-align: center; margin: 15px 0;">
                        ${isEsente ? 'ESENTE' : `‚Ç¨ ${results.totalIMU.toFixed(2)}`}
                    </div>
                    ${!isEsente ? `
                        <div style="text-align: center; margin-top: 15px;">
                            <p><strong>Acconto (16/06/2025):</strong> ‚Ç¨ ${results.acconto.toFixed(2)}</p>
                            <p><strong>Saldo (16/12/2025):</strong> ‚Ç¨ ${results.saldo.toFixed(2)}</p>
                        </div>
                    ` : ''}
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="generatePDFReport()" style="margin-right: 10px;">
                            üìÑ Genera Report PDF
                        </button>
                        <button class="btn" onclick="downloadCSV()" style="background: #28a745;">
                            üìä Esporta Excel
                        </button>
                    </div>
                </div>

                <h4 style="margin: 20px 0;">üìã Dettaglio per Immobile</h4>
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="border: 1px solid #dee2e6; padding: 12px; text-align: left;">Immobile</th>
                            <th style="border: 1px solid #dee2e6; padding: 12px; text-align: left;">Categoria</th>
                            <th style="border: 1px solid #dee2e6; padding: 12px; text-align: right;">Base Imponibile</th>
                            <th style="border: 1px solid #dee2e6; padding: 12px; text-align: left;">Configurazione</th>
                            <th style="border: 1px solid #dee2e6; padding: 12px; text-align: right;">IMU</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${results.details.map(detail => `
                            <tr style="${detail.importo === 0 ? 'background: #d4edda;' : ''}">
                                <td style="border: 1px solid #dee2e6; padding: 12px;">
                                    <strong>${detail.immobile}</strong><br>
                                    <small style="color: #6c757d;">${detail.indirizzo}</small>
                                </td>
                                <td style="border: 1px solid #dee2e6; padding: 12px;">${detail.categoria}</td>
                                <td style="border: 1px solid #dee2e6; padding: 12px; text-align: right;">‚Ç¨ ${detail.baseImponibile.toFixed(2)}</td>
                                <td style="border: 1px solid #dee2e6; padding: 12px;">
                                    ${detail.tipo}
                                    ${detail.importo === 0 ? '<br><span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.8em;">ESENTE</span>' : ''}
                                </td>
                                <td style="border: 1px solid #dee2e6; padding: 12px; text-align: right; font-weight: bold;">
                                    ${detail.importo === 0 ? 'ESENTE' : `‚Ç¨ ${detail.importo.toFixed(2)}`}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>

                <h4 style="margin: 20px 0;">‚öñÔ∏è Normativa Applicata</h4>
                <ul style="background: #e7f3ff; padding: 15px; border-radius: 8px; border-left: 4px solid #0066cc;">
                    ${results.normativa.map(norma => `<li style="margin-bottom: 8px;">${norma}</li>`).join('')}
                </ul>
            `;
            
            imuResultsDiv.innerHTML = html;
            imuResultsDiv.style.display = 'block';
            
            // Scroll ai risultati
            imuResultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // Funzione per generare PDF report
        window.generatePDFReport = function() {
            alert('üöß Funzionalit√† PDF in fase di implementazione. Presto disponibile!');
            // TODO: Implementare generazione PDF tramite server
        };

        // Funzione per esportare CSV
        window.downloadCSV = function() {
            alert('üöß Funzionalit√† Export Excel in fase di implementazione. Presto disponibile!');
            // TODO: Implementare esportazione CSV
        };

        window.toggleDebug = function() {
            const debugContent = document.getElementById('debugContent');
            debugContent.style.display = debugContent.style.display === 'none' ? 'block' : 'none';
        };
    </script>
</body>
</html> 